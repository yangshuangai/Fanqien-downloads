<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>番茄小说下载器</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .progress-bar { width: 300px; height: 20px; border: 1px solid #ccc; }
        .progress { height: 100%; background: #4CAF50; transition: width 0.3s; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>番茄小说下载器</h1>
    
    <form id="downloadForm">
        <input type="text" name="book_id" placeholder="输入小说ID" required>
        <button type="submit">开始下载</button>
    </form>

    <h2>进行中的任务</h2>
    <div id="tasks"></div>

    <h2>已下载小说</h2>
    <ul id="books">
        {% for book in books %}
            <li>
                {{ book.replace('.txt', '') }}
                <button onclick="updateBook('{{ book.split('.')[0] }}')">更新</button>
            </li>
        {% endfor %}
    </ul>

    <script>
        const form = document.getElementById('downloadForm');
        const tasksDiv = document.getElementById('tasks');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const bookId = form.book_id.value;
            
            try {
                const response = await axios.post('/download', new URLSearchParams({ book_id: bookId }));
                startProgressPolling(response.data.task_id);
            } catch (error) {
                alert(error.response?.data?.error || '请求失败');
            }
        });

        function startProgressPolling(taskId) {
            const checkProgress = async () => {
                try {
                    const response = await axios.get(`/progress/${taskId}`);
                    updateTaskUI(taskId, response.data);
                    
                    if (response.data.status.includes('running')) {
                        setTimeout(checkProgress, 1000);
                    }
                } catch (error) {
                    console.error('进度检查失败:', error);
                }
            };
            checkProgress();
        }

        function updateTaskUI(taskId, task) {
            let taskElement = document.getElementById(taskId);
            if (!taskElement) {
                taskElement = document.createElement('div');
                taskElement.id = taskId;
                tasksDiv.appendChild(taskElement);
            }
            
            taskElement.innerHTML = `
                <h3>任务ID: ${taskId}</h3>
                <div class="${task.status.includes('failed') ? 'error' : ''}">
                    状态: ${task.status}
                </div>
                ${task.status === 'running' ? `
                <div class="progress-bar">
                    <div class="progress" style="width: ${task.progress}%"></div>
                </div>
                <div>当前章节: ${task.current_chapter || '初始化中...'}</div>
                ` : ''}
            `;
        }

        function updateBook(bookId) {
            axios.get(`/update/${bookId}`)
                .then(() => {
                    startProgressPolling(bookId);
                    alert('已开始更新');
                })
                .catch(err => alert('更新请求失败'));
        }
    </script>
</body>
</html>