<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>番茄小说下载器</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .progress-container { margin: 20px 0; }
        .progress-bar { 
            width: 300px; 
            height: 20px; 
            border: 1px solid #ccc; 
            position: relative;
            margin: 5px 0;
        }
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s;
        }
        .progress-text {
            position: absolute;
            width: 100%;
            text-align: center;
            top: 50%;
            transform: translateY(-50%);
        }
        .task-box {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>番茄小说下载器</h1>
    
    <form id="downloadForm">
        <input type="text" name="book_id" placeholder="输入小说ID" required>
        <button type="submit">开始下载</button>
    </form>

    <h2>进行中的任务</h2>
    <div id="tasks"></div>

    <h2>已下载小说</h2>
    <ul id="books">
        {% for book in books %}
            <li>
                {{ book.replace('.txt', '') }}
                <button onclick="updateBook('{{ book.split('.')[0] }}')">更新</button>
            </li>
        {% endfor %}
    </ul>

    <script>
        const form = document.getElementById('downloadForm');
        const tasksDiv = document.getElementById('tasks');

        // 新增：进度动画函数
        function animateProgress(element, targetWidth) {
            element.style.width = targetWidth + '%';
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const bookId = form.book_id.value;
            
            try {
                const response = await axios.post('/download', new URLSearchParams({ book_id: bookId }));
                startProgressPolling(response.data.task_id);
                form.reset();
            } catch (error) {
                alert(error.response?.data?.error || '请求失败');
            }
        });

        function startProgressPolling(taskId) {
            let retryCount = 0;
            
            const checkProgress = async () => {
                try {
                    const response = await axios.get(`/progress/${taskId}`);
                    updateTaskUI(taskId, response.data);
                    
                    if (response.data.status.includes('running')) {
                        setTimeout(checkProgress, 500);  // 改为500ms轮询
                    } else {
                        // 任务完成后刷新列表
                        setTimeout(() => location.reload(), 2000);
                    }
                } catch (error) {
                    if (retryCount++ < 3) {
                        setTimeout(checkProgress, 1000);
                    }
                }
            };
            checkProgress();
        }

        function updateTaskUI(taskId, task) {
            let taskElement = document.getElementById(taskId);
            if (!taskElement) {
                taskElement = document.createElement('div');
                taskElement.id = taskId;
                taskElement.className = 'task-box';
                tasksDiv.appendChild(taskElement);
            }
            
            // 新增详细进度显示
            taskElement.innerHTML = `
                <h3>任务ID: ${taskId}</h3>
                <div class="${task.status.includes('failed') ? 'error' : ''}">
                    状态: ${task.status.replace('running', '下载中...')}
                </div>
                ${task.status === 'running' ? `
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${task.progress}%"></div>
                        <div class="progress-text">${task.progress}%</div>
                    </div>
                    <div>当前进度：${task.current_chapter || '初始化中...'} / 共${task.total_chapters}章</div>
                </div>
                ` : ''}
            `;

            // 触发CSS过渡动画
            const progressFill = taskElement.querySelector('.progress-fill');
            if (progressFill) {
                animateProgress(progressFill, task.progress);
            }
        }

        function updateBook(bookId) {
            axios.get(`/update/${bookId}`)
                .then(() => {
                    startProgressPolling(bookId);
                    alert('已开始更新');
                })
                .catch(err => alert('更新请求失败'));
        }
    </script>
</body>
</html>
